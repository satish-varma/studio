
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      let userDocPath = /databases/$(database)/documents/users/$(userId);
      return exists(userDocPath) ? get(userDocPath).data : null;
    }

    function getAuthenticatedUserData() {
      return isSignedIn() ? getUserData(request.auth.uid) : null;
    }

    function getAuthenticatedUserRole() {
      let userData = getAuthenticatedUserData();
      return userData != null ? userData.role : null;
    }

    function isAdmin() {
      return getAuthenticatedUserRole() == 'admin';
    }

    function isManagerRole() {
      return getAuthenticatedUserRole() == 'manager';
    }

    function isStaffRole() {
      return getAuthenticatedUserRole() == 'staff';
    }

    function isManagerOfSite(siteId) {
      let userData = getAuthenticatedUserData();
      return isManagerRole() &&
             userData != null &&
             userData.managedSiteIds != null &&
             userData.managedSiteIds.hasAny([siteId]);
    }

    function isStaffAssignedTo(siteId, stallId) {
      let userData = getAuthenticatedUserData();
      return isStaffRole() &&
             userData != null &&
             userData.defaultSiteId == siteId &&
             userData.defaultStallId == stallId;
    }
    
    function isStaffAssignedToSiteOnly(siteId) {
      let userData = getAuthenticatedUserData();
      return isStaffRole() &&
             userData != null &&
             userData.defaultSiteId == siteId;
    }

    // --- Collections Rules ---

    match /users/{userId} {
      allow read: if isUser(userId) || isAdmin() || isManagerRole();
      allow create: if isAdmin();
      // Admins can update any user.
      // Other users can only update their own document, and cannot change protected fields.
      allow update: if isAdmin() ||
                      (isUser(userId) &&
                       !request.resource.data.keys().hasAny(['role', 'uid', 'email', 'createdAt', 'status', 'managedSiteIds', 'defaultSiteId', 'defaultStallId']));
      allow delete: if isAdmin() && request.auth.uid != userId;
    }
    match /users/{allUsers=**} {
      allow list: if isAdmin() || isManagerRole();
    }

    match /sites/{siteId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    match /sites/{allSites=**} {
      allow list: if isSignedIn();
    }

    match /stalls/{stallId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    match /stalls/{allStalls=**} {
      allow list: if isSignedIn();
    }

    match /stockItems/{itemId} {
      function isAllocationAllowed() {
        let masterItem = resource.data;
        let stallItem = request.resource.data;
        return stallItem.originalMasterItemId == resource.id &&
               masterItem.quantity - stallItem.quantity == request.resource.data.quantity;
      }
      function isReturnToMasterAllowed() {
        let stallItem = resource.data;
        let masterItem = request.resource.data;
        return masterItem.id == stallItem.originalMasterItemId &&
               masterItem.quantity == stallItem.quantity + resource.data.quantity;
      }
       function isTransferAllowed() {
        let sourceStallItem = resource.data;
        let destStallItem = request.resource.data;
        // Ensure they are from the same master item and site, but different stalls
        return sourceStallItem.originalMasterItemId == destStallItem.originalMasterItemId &&
               sourceStallItem.siteId == destStallItem.siteId &&
               sourceStallItem.stallId != destStallItem.stallId;
      }

      allow read: if isSignedIn();

      allow create: if request.resource.data.siteId != null &&
                       (isAdmin() ||
                        (isManagerRole() && isManagerOfSite(request.resource.data.siteId)) ||
                        (isStaffRole() && 
                          ( (request.resource.data.stallId != null && isStaffAssignedTo(request.resource.data.siteId, request.resource.data.stallId)) || 
                            (request.resource.data.stallId == null && isStaffAssignedToSiteOnly(request.resource.data.siteId)) 
                          )
                        )
                       ) &&
                       request.resource.data.name is string && request.resource.data.name.size() > 0 &&
                       request.resource.data.quantity is number && request.resource.data.quantity >= 0 &&
                       request.resource.data.price is number && request.resource.data.price >= 0 &&
                       request.resource.data.lastUpdated is string; 

      allow update: if resource.data.siteId != null &&
                       (isAdmin() ||
                        (isManagerRole() && isManagerOfSite(resource.data.siteId)) || // Managers can update items in their sites (all fields if needed, client controls specifics)
                        (isStaffRole() && isStaffAssignedToSiteOnly(resource.data.siteId) &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['quantity', 'lastUpdated'])
                        )
                       ) &&
                       request.resource.data.lastUpdated is string &&
                       request.resource.data.quantity is number && request.resource.data.quantity >= 0 &&
                       (request.resource.data.siteId == resource.data.siteId || isAdmin()) && 
                       (request.resource.data.stallId == resource.data.stallId || isAdmin()) &&
                       (!request.resource.data.keys().hasAny(['originalMasterItemId']) || isAdmin());


      allow delete: if resource.data.siteId != null &&
           (isAdmin() ||
             (isManagerRole() && isManagerOfSite(resource.data.siteId) &&
               // Prevent manager from deleting master item if it has allocations with stock > 0
               (resource.data.stallId != null || (
                 !exists(/databases/$(database)/documents/stockItems/$(request.path.split('/')[6])) ||
                 get(/databases/$(database)/documents/stockItems/$(request.path.split('/')[6])).data.quantity == 0
               ))
             ) ||
             (isStaffRole() && resource.data.stallId != null && isStaffAssignedTo(resource.data.siteId, resource.data.stallId))
           );
    }

    match /salesTransactions/{transactionId} {
      allow create: if isSignedIn() && 
                       request.resource.data.staffId == request.auth.uid && 
                       request.resource.data.siteId != null &&
                       request.resource.data.stallId != null &&
                       (isAdmin() || 
                        (isManagerRole() && isManagerOfSite(request.resource.data.siteId) && request.resource.data.stallId != null) ||
                        (isStaffRole() && isStaffAssignedTo(request.resource.data.siteId, request.resource.data.stallId)) 
                       ) &&
                       request.resource.data.isDeleted == false &&
                       request.resource.data.items is list && request.resource.data.items.size() > 0 &&
                       request.resource.data.totalAmount is number && request.resource.data.totalAmount >= 0;

      allow read: if (isStaffRole() && resource.data.staffId == request.auth.uid) || 
                     (isManagerRole() && isManagerOfSite(resource.data.siteId)) ||
                     isAdmin();

      allow update: if isAdmin() &&
                       request.resource.data.isDeleted == true &&
                       resource.data.isDeleted == false && 
                       request.resource.data.deletedBy == request.auth.uid &&
                       request.resource.data.deletionJustification is string && request.resource.data.deletionJustification.size() > 0 &&
                       request.resource.data.deletedAt is string && 
                       !request.resource.data.keys().hasAny(['items', 'totalAmount', 'transactionDate', 'staffId', 'siteId', 'stallId', 'staffName']);

      allow delete: if false;
    }
    match /salesTransactions/{allSales=**} {
        allow list: if isSignedIn();
    }

    match /stockMovementLogs/{logId} {
      allow create: if isSignedIn() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.stockItemId is string &&
                       request.resource.data.siteId is string &&
                       request.resource.data.type is string &&
                       request.resource.data.quantityChange is number &&
                       request.resource.data.quantityBefore is number &&
                       request.resource.data.quantityAfter is number &&
                       request.resource.data.timestamp is string;

      allow read: if isAdmin() || 
                     (isManagerRole() && isManagerOfSite(resource.data.siteId));

      allow update, delete: if false;
    }
    match /stockMovementLogs/{allLogs=**} {
        allow list: if isAdmin() || isManagerRole();
    }
    
    // --- Food Stall Specific Rules ---
    
    match /foodItemExpenses/{expenseId} {
      allow create: if isSignedIn() &&
                       request.resource.data.recordedByUid == request.auth.uid &&
                       request.resource.data.siteId != null &&
                       request.resource.data.stallId != null &&
                       (isAdmin() ||
                        (isManagerRole() && isManagerOfSite(request.resource.data.siteId)) ||
                        (isStaffRole() && isStaffAssignedTo(request.resource.data.siteId, request.resource.data.stallId))
                       );
                       
      allow read: if isSignedIn() &&
                     (isAdmin() ||
                      (isManagerRole() && isManagerOfSite(resource.data.siteId)) ||
                      (isStaffRole() && isStaffAssignedTo(resource.data.siteId, resource.data.stallId))
                     );
                     
      allow update: if isSignedIn() &&
                       (isAdmin() ||
                        (isManagerRole() && isManagerOfSite(request.resource.data.siteId))
                       );

      allow delete: if isAdmin();
    }
    
    match /foodSaleTransactions/{saleId} {
      allow create, update: if isSignedIn() &&
                         request.resource.data.recordedByUid == request.auth.uid &&
                         request.resource.data.siteId != null &&
                         request.resource.data.stallId != null &&
                         (isAdmin() ||
                          (isManagerRole() && isManagerOfSite(request.resource.data.siteId)) ||
                          (isStaffRole() && isStaffAssignedTo(request.resource.data.siteId, request.resource.data.stallId))
                         );

      allow read: if isSignedIn() &&
                     (isAdmin() ||
                      (isManagerRole() && isManagerOfSite(resource.data.siteId)) ||
                      (isStaffRole() && isStaffAssignedTo(resource.data.siteId, resource.data.stallId))
                     );
                     
      allow delete: if isAdmin();
    }

    match /foodStallActivityLogs/{logId} {
      allow create: if isSignedIn() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.siteId is string &&
                       request.resource.data.stallId is string &&
                       request.resource.data.type is string &&
                       request.resource.data.relatedDocumentId is string &&
                       request.resource.data.timestamp is string;

      allow read: if isAdmin() || (isManagerRole() && isManagerOfSite(resource.data.siteId));
      
      allow update, delete: if false;
    }
     match /foodStallActivityLogs/{allLogs=**} {
        allow list: if isAdmin() || isManagerRole();
    }
    
    match /foodVendors/{vendorId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isManagerRole();
    }
    
    match /foodExpensePresets/{presetId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || isManagerRole();
    }
    
    // --- Staff Management Specific Rules ---
    
    match /staffDetails/{userId} {
      function getStaffSiteId() {
        return getUserData(userId).defaultSiteId;
      }
      
      allow read: if isUser(userId) || isAdmin() || (isManagerRole() && isManagerOfSite(getStaffSiteId()));

      allow create, update: if isAdmin() || (isManagerRole() && isManagerOfSite(getStaffSiteId()));

      allow delete: if isAdmin();
    }
    
    match /staffAttendance/{attendanceId} {
      allow create, update: if isSignedIn() &&
                               request.resource.data.siteId != null &&
                               (isAdmin() || (isManagerRole() && isManagerOfSite(request.resource.data.siteId)));
      
      allow read: if isSignedIn() &&
                     (isAdmin() || (isManagerRole() && isManagerOfSite(resource.data.siteId)));
      
      allow delete: if isAdmin();
    }
    match /staffAttendance/{allAttendance=**} {
        allow list: if isSignedIn() && (isAdmin() || isManagerRole());
    }

    match /advances/{advanceId} {
      // This is the corrected rule.
      // It ensures that the person creating the advance is an admin,
      // OR a manager of the site that the staff member belongs to.
      // The staff's site ID is now passed in the document itself.
      allow create: if isSignedIn() &&
                      request.resource.data.recordedByUid == request.auth.uid &&
                      request.resource.data.siteId != null &&
                      request.resource.data.staffSiteId != null &&
                      (isAdmin() || 
                        (isManagerRole() && isManagerOfSite(request.resource.data.siteId) && request.resource.data.siteId == request.resource.data.staffSiteId)
                      );

      allow read: if isSignedIn() &&
                     (isAdmin() || (isManagerRole() && isManagerOfSite(resource.data.siteId)));
      
      allow delete: if isAdmin();
    }
    match /advances/{allAdvances=**} {
      allow list: if isSignedIn() && (isAdmin() || isManagerRole());
    }
    
    match /holidays/{holidayId} {
      allow read, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /staffActivityLogs/{logId} {
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow read: if isAdmin() || (isManagerRole() && isManagerOfSite(resource.data.siteId));
        allow list: if isAdmin() || isManagerRole();
        allow update, delete: if false;
    }
    
    match /salaryPayments/{paymentId} {
        allow create: if isSignedIn() &&
                       request.resource.data.recordedByUid == request.auth.uid &&
                       request.resource.data.siteId != null &&
                       (isAdmin() || (isManagerRole() && isManagerOfSite(request.resource.data.siteId)));
        
        allow read: if isSignedIn() &&
                     (isAdmin() || (isManagerRole() && isManagerOfSite(resource.data.siteId)) || 
                      (isStaffRole() && resource.data.staffUid == request.auth.uid));

        allow list: if isSignedIn() && (isAdmin() || isManagerRole());
        allow update, delete: if isAdmin();
    }

    // --- Gmail Integration Rules ---

    match /user_tokens/{userId} {
      allow read, create, update: if isUser(userId);
      allow delete, list: if false;
    }
  }
}

    